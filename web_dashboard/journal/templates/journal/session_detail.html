{% extends 'base.html' %}

{% block content %}
<style>
    .chart-toolbar {
        background: #1e222d;
        padding: 8px 15px;
        border-bottom: 1px solid #363c4e;
        display: flex;
        gap: 12px;
        align-items: center;
    }
    .btn-chart-ctrl {
        background: #2a2e39;
        border: 1px solid #434651;
        color: #d1d4dc;
        padding: 4px 12px;
        font-size: 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    .btn-chart-ctrl:hover {
        background: #363c4e;
        color: white;
    }
    .btn-chart-ctrl.active {
        background: #2962ff;
        border-color: #2962ff;
        color: white;
    }
    .stat-card {
        background-color: #1e1e1e;
        border: 1px solid #333;
        text-align: center;
        padding: 12px;
    }
    /* Toggle Switch Style */
    .form-switch .form-check-input {
        cursor: pointer;
        width: 2.5em;
        height: 1.25em;
    }
    .trade-table-container {
        max-height: 350px;
        overflow-y: auto;
    }
    .table-dark {
        --bs-table-bg: #1e1e1e;
    }
</style>

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>
            <i class="fas fa-terminal text-primary"></i> Session #{{ session.id }}
            <small class="text-muted fs-6">[{{ session.symbol }} | {{ session.agent_name }}]</small>
        </h4>
        <a href="{% url 'dashboard' %}" class="btn btn-outline-secondary btn-sm">
            <i class="fas fa-arrow-left"></i> Dashboard
        </a>
    </div>

    <div class="row mb-3">
        <div class="col-md-3">
            <div class="stat-card card">
                <small class="text-muted">Net Profit</small>
                <h4 class="mb-0 {% if session.net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                    ${{ session.net_profit|stringformat:".2f" }}
                </h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card card">
                <small class="text-muted">Win Rate</small>
                <h4 class="mb-0 text-info">{{ session.win_rate|stringformat:".1f" }}%</h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card card">
                <small class="text-muted">Max Drawdown</small>
                <h4 class="mb-0 text-danger">{{ session.max_drawdown_percent|stringformat:".2f" }}%</h4>
            </div>
        </div>
        <div class="col-md-3">
            <div class="stat-card card">
                <small class="text-muted">Total Trades</small>
                <h4 class="mb-0">{{ session.total_trades }}</h4>
            </div>
        </div>
    </div>

    <div class="card mb-3 bg-dark border-secondary overflow-hidden">
        <div class="chart-toolbar">
            <div class="d-flex gap-1 align-items-center">
                <button class="btn-chart-ctrl active" onclick="changeTF(1, this)">1m</button>
                <button class="btn-chart-ctrl" onclick="changeTF(5, this)">5m</button>
                <button class="btn-chart-ctrl" onclick="changeTF(15, this)">15m</button>
                <button class="btn-chart-ctrl" onclick="changeTF(60, this)">1h</button>
            </div>

            <div class="vr mx-2 bg-secondary"></div>

            <div class="form-check form-switch mb-0">
                <input class="form-check-input" type="checkbox" id="markerToggle" checked onchange="toggleMarkers()">
                <label class="form-check-label small text-muted" for="markerToggle">Show Signals</label>
            </div>

            <div class="ms-auto d-flex gap-2">
                <button class="btn-chart-ctrl" onclick="resetChart()"><i class="fas fa-expand"></i> Reset</button>
                <button class="btn-chart-ctrl" onclick="toggleLogScale(this)">LOG</button>
            </div>
        </div>

        <div class="card-body p-0 position-relative">
            <div id="tv-chart" style="width: 100%; height: 500px; background-color: #131722;"></div>
        </div>
    </div>

    <div class="card bg-dark border-secondary">
        <div class="card-header py-2 d-flex justify-content-between align-items-center">
            <span class="small fw-bold"><i class="fas fa-list"></i> EXECUTION LOG</span>
            <span class="badge bg-primary">{{ trades|length }} Trades</span>
        </div>
        <div class="trade-table-container">
            <table class="table table-dark table-sm table-hover mb-0" style="font-size: 0.85rem;">
                <thead class="sticky-top bg-dark">
                    <tr>
                        <th>Ticket</th>
                        <th>Type</th>
                        <th>Open Time</th>
                        <th>Entry</th>
                        <th>Exit</th>
                        <th>P/L</th>
                        <th>Reason</th>
                    </tr>
                </thead>
                <tbody>
                    {% for trade in trades %}
                    <tr style="cursor: pointer;" onclick="focusTrade({{ trade.open_time|date:'U' }})">
                        <td>#{{ trade.ticket }}</td>
                        <td>
                            <span class="badge {% if trade.direction == 'BUY' %}bg-primary{% else %}bg-warning text-dark{% endif %}">
                                {{ trade.direction }}
                            </span>
                        </td>
                        <td>{{ trade.open_time|date:"Y-m-d H:i" }}</td>
                        <td>{{ trade.entry_price|stringformat:".2f" }}</td>
                        <td>{{ trade.exit_price|stringformat:".2f" }}</td>
                        <td class="fw-bold {% if trade.net_profit >= 0 %}text-success{% else %}text-danger{% endif %}">
                            ${{ trade.net_profit|stringformat:".2f" }}
                        </td>
                        <td class="text-muted small">{{ trade.entry_reason }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
<script>
    let chart, candlestickSeries, volumeSeries;
    let rawData = { candles: [], volume: [], markers: [] };
    let currentMarkers = [];
    let markersVisible = true;
    let currentMinutes = 1;
    const container = document.getElementById('tv-chart');

    document.addEventListener("DOMContentLoaded", async () => {
        try {
            const response = await fetch("{% url 'session_chart_data' session.id %}");
            const data = await response.json();

            rawData.candles = data.chart_data.sort((a, b) => a.time - b.time);
            rawData.volume = data.volume_data.sort((a, b) => a.time - b.time);
            rawData.markers = data.markers_data || [];

            initChart();
            renderData(1);
        } catch (e) {
            container.innerHTML = '<div class="text-danger p-5 text-center">Data fetch failed. Run backtest first.</div>';
        }
    });

    function initChart() {
        chart = LightweightCharts.createChart(container, {
            layout: { background: { color: '#131722' }, textColor: '#d1d4dc' },
            grid: { vertLines: { color: '#242733' }, horzLines: { color: '#242733' } },
            timeScale: { timeVisible: true, borderColor: '#363c4e' },
            rightPriceScale: { borderColor: '#363c4e' },
            crosshair: { mode: LightweightCharts.CrosshairMode.Normal },
        });

        candlestickSeries = chart.addCandlestickSeries({
            upColor: '#26a69a', downColor: '#ef5350', borderVisible: false, wickUpColor: '#26a69a', wickDownColor: '#ef5350'
        });

        volumeSeries = chart.addHistogramSeries({
            color: '#26a69a', priceFormat: { type: 'volume' }, priceScaleId: '',
        });
        volumeSeries.priceScale().applyOptions({ scaleMargins: { top: 0.8, bottom: 0 } });

        new ResizeObserver(() => chart.resize(container.clientWidth, container.clientHeight)).observe(container);
    }

    function aggregateData(minutes) {
        if (minutes === 1) return { c: rawData.candles, v: rawData.volume };
        const newCandles = [], newVolume = [], interval = minutes * 60;

        for (let i = 0; i < rawData.candles.length; i++) {
            const c = rawData.candles[i];
            const ts = Math.floor(c.time / interval) * interval;
            let last = newCandles[newCandles.length - 1];

            if (!last || last.time !== ts) {
                newCandles.push({ ...c, time: ts });
                newVolume.push({ ...rawData.volume[i], time: ts });
            } else {
                last.high = Math.max(last.high, c.high);
                last.low = Math.min(last.low, c.low);
                last.close = c.close;
                newVolume[newVolume.length - 1].value += rawData.volume[i].value;
            }
        }
        return { c: newCandles, v: newVolume };
    }

    function renderData(minutes) {
        currentMinutes = minutes;
        const agg = aggregateData(minutes);
        candlestickSeries.setData(agg.c);
        volumeSeries.setData(agg.v);

        // Prepare Markers
        const interval = minutes * 60;
        const markers = rawData.markers.map(m => ({
            ...m, time: Math.floor(m.time / interval) * interval
        }));
        currentMarkers = markers.filter((v, i, a) => a.findIndex(t => (t.time === v.time && t.text === v.text)) === i);

        updateMarkersVisibility();
        chart.timeScale().fitContent();
    }

    function updateMarkersVisibility() {
        candlestickSeries.setMarkers(markersVisible ? currentMarkers : []);
    }

    function toggleMarkers() {
        markersVisible = document.getElementById('markerToggle').checked;
        updateMarkersVisibility();
    }

    function changeTF(minutes, btn) {
        document.querySelectorAll('.btn-chart-ctrl').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderData(minutes);
    }

    function resetChart() { chart.timeScale().fitContent(); }

    function toggleLogScale(btn) {
        const isLog = btn.classList.toggle('active');
        chart.priceScale('right').applyOptions({
            mode: isLog ? LightweightCharts.PriceScaleMode.Logarithmic : LightweightCharts.PriceScaleMode.Normal,
        });
    }

    function focusTrade(timestamp) {
        // Scroll chart to the specific trade time
        chart.timeScale().scrollToPosition(0, false);
        chart.timeScale().setVisibleRange({
            from: parseInt(timestamp) - (currentMinutes * 60 * 50),
            to: parseInt(timestamp) + (currentMinutes * 60 * 50)
        });
    }
</script>
{% endblock %}